# Grafana Datasource Provisioning
# Auto-configures all observability datasources on startup
# This eliminates manual setup - just spin up and it works

apiVersion: 1

datasources:
  # Prometheus - for metrics
  - name: Prometheus
    type: prometheus
    uid: prometheus
    access: proxy
    url: http://prometheus:9090
    isDefault: true
    editable: false
    jsonData:
      httpMethod: POST
      manageAlerts: true
      prometheusType: Prometheus
      prometheusVersion: "2.50.0"

  # Loki - for logs
  - name: Loki
    type: loki
    uid: loki
    access: proxy
    url: http://loki:3100
    editable: false
    jsonData:
      maxLines: 1000
      derivedFields:
        # Link trace_id in logs to Tempo traces
        - name: TraceID
          matcherRegex: '\[trace_id=([0-9a-f]{32})\]'
          url: "$${__value.raw}"
          datasourceUid: tempo
          urlDisplayLabel: View Trace

  # Tempo - for distributed traces (primary)
  - name: Tempo
    type: tempo
    uid: tempo
    access: proxy
    url: http://tempo:3200
    editable: false
    jsonData:
      tracesToLogsV2:
        datasourceUid: loki
        spanStartTimeShift: "-1h"
        spanEndTimeShift: "1h"
        filterByTraceID: true
        filterBySpanID: false
        customQuery: true
        query: '{deployment_environment="development"} | trace_id="$${__trace.traceId}"'
      tracesToMetrics:
        datasourceUid: prometheus
        spanStartTimeShift: "-1h"
        spanEndTimeShift: "1h"
        tags:
          - key: service.name
            value: service
        queries:
          - name: Request rate
            query: 'sum(rate(http_requests_total{service="$${__tags.service}"}[5m]))'
          - name: Error rate
            query: 'sum(rate(http_requests_total{service="$${__tags.service}", status=~"5.."}[5m])) / sum(rate(http_requests_total{service="$${__tags.service}"}[5m]))'
      # nodeGraph:
      #   enabled: true
      # serviceMap:
      #   datasourceUid: prometheus
      # search:
      #   hide: false
      # lokiSearch:
      #   datasourceUid: loki
      # Don't know what this is so i will put it here for later stuff